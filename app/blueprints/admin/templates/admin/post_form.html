{% extends "admin/admin_base.html" %}
{% set active_menu = 'post_new' if not post else 'post_list' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/tinymce/tinymce.min.js') }}"></script>
<script>
    tinymce.init({
        license_key: 'gpl',
        selector: '#content',
        language: 'ja',
        height: 500,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount'
        ],
        toolbar: 'undo redo | blocks | ' +
            'bold italic underline strikethrough | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'link image media | table | removeformat | help',
        content_style: 'body { font-family: "Noto Sans JP", sans-serif; font-size:14px }',
        branding: false,
        promotion: false,
        elementpath: false,
        menubar: 'edit insert view format table tools help',
        skin: 'oxide',
        content_css: 'default'
    });

    // アイキャッチプレビュー
    document.getElementById('eyecatch_img').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const previewContainer = document.getElementById('eyecatch-preview-container');
                let img = document.getElementById('eyecatch-preview');
                const placeholder = document.getElementById('eyecatch-placeholder');

                if (!img) {
                    img = document.createElement('img');
                    img.id = 'eyecatch-preview';
                    img.className = 'w-full h-full object-cover';
                    previewContainer.appendChild(img);
                }

                if (placeholder) placeholder.style.display = 'none';
                img.src = e.target.result;
                img.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    });

    // カテゴリー変更時のイベント開催日必須チェック
    const categorySelect = document.getElementById('category_id');
    const eventDateInput = document.getElementById('event_date');
    const eventDateLabel = document.querySelector('label[for="event_date"]');

    function updateEventDateRequirement() {
        if (!categorySelect) return;
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const slug = selectedOption.getAttribute('data-slug');

        if (slug === 'event') {
            eventDateInput.required = true;
            if (!eventDateLabel.querySelector('.required-mark')) {
                const mark = document.createElement('span');
                mark.className = 'text-red-500 ml-1 required-mark';
                mark.innerText = '*';
                eventDateLabel.appendChild(mark);
            }
        } else {
            eventDateInput.required = false;
            const mark = eventDateLabel.querySelector('.required-mark');
            if (mark) mark.remove();
        }
    }

    if (categorySelect) {
        categorySelect.addEventListener('change', updateEventDateRequirement);
        updateEventDateRequirement(); // 初期表示時にも実行
    }
</script>
{% endblock %}

{% block main_content %}
<!-- PAGE HEADER -->
<div class="flex flex-col gap-2">
    <div class="flex items-center gap-1.5 text-[11px] font-mono-dm text-custom-text-muted uppercase tracking-wider">
        <span class="text-custom-accent font-bold">Admin</span>
        <span class="opacity-40">/</span>
        <span class="text-custom-accent font-bold">Posts</span>
        <span class="opacity-40">/</span>
        <span>{{ 'Edit Post' if post else 'New Post' }}</span>
    </div>
    <div class="flex items-center gap-4">
        <a href="{{ url_for('admin.post_list') }}"
            class="text-custom-text-muted hover:text-custom-accent transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
            </svg>
        </a>
        <h1 class="text-2xl md:text-3xl font-header-sans font-bold text-custom-text-primary tracking-tight">{{ title }}
        </h1>
    </div>
</div>

<!-- FORM CARD -->
<div class="bg-white border border-custom-border rounded-custom shadow-custom-sm overflow-hidden w-full">
    <form method="POST" enctype="multipart/form-data" class="p-6 md:p-8 flex flex-col gap-6">
        <!-- 見出し -->
        <div>
            <label for="title" class="label-admin">見出し <span class="text-red-500 ml-1">*</span></label>
            <input type="text" id="title" name="title" value="{{ post.title if post else '' }}" placeholder="記事のタイトルを入力"
                class="input-admin text-base font-bold" required>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- カテゴリー -->
            <div>
                <label for="category_id" class="label-admin">カテゴリー <span class="text-red-500 ml-1">*</span></label>
                <div class="relative">
                    <select id="category_id" name="category_id" class="input-admin appearance-none cursor-pointer pr-10"
                        required>
                        {% for category in categories %}
                        <option value="{{ category.id }}" data-slug="{{ category.slug }}" {{ 'selected' if post and
                            post.category_id==category.id else '' }}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    <span
                        class="absolute right-3.5 top-1/2 -translate-y-1/2 text-[10px] text-custom-text-muted pointer-events-none">▼</span>
                </div>
            </div>

            <!-- 投稿者 (Author) -->
            <div>
                <label for="user_id" class="label-admin">投稿者 <span class="text-red-500 ml-1">*</span></label>
                <div class="relative">
                    <select id="user_id" name="user_id" class="input-admin appearance-none cursor-pointer pr-10"
                        required>
                        {% for user in users %}
                        <option value="{{ user.id }}" {{ 'selected' if (post and post.user_id==user.id) or (not post and
                            current_user.id==user.id) else '' }}>
                            {{ user.display_name_or_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <span
                        class="absolute right-3.5 top-1/2 -translate-y-1/2 text-[10px] text-custom-text-muted pointer-events-none">▼</span>
                </div>
            </div>

            <!-- 公開日時 -->
            <div>
                <label for="published_at" class="label-admin">公開日時 <span class="text-red-500 ml-1">*</span></label>
                <input type="datetime-local" id="published_at" name="published_at"
                    value="{{ post.published_at.strftime('%Y-%m-%dT%H:%M') if post and post.published_at else '' }}"
                    class="input-admin" required>
            </div>

            <!-- イベント開催日 -->
            <div>
                <label for="event_date" class="label-admin">イベント開催日 <span
                        class="text-xs font-normal text-custom-text-muted ml-2">※イベントの場合のみ設定</span></label>
                <input type="datetime-local" id="event_date" name="event_date"
                    value="{{ post.event_date.strftime('%Y-%m-%dT%H:%M') if post and post.event_date else '' }}"
                    class="input-admin">
            </div>
        </div>

        <!-- アイキャッチ画像 -->
        <div>
            <label for="eyecatch_img" class="label-admin">アイキャッチ画像</label>
            <div class="flex flex-col md:flex-row gap-4 items-start">
                <div id="eyecatch-preview-container"
                    class="w-full md:w-48 aspect-video bg-custom-surface-2 border border-custom-border rounded-lg overflow-hidden flex items-center justify-center relative group">
                    {% if post and post.eyecatch_img %}
                    <img id="eyecatch-preview"
                        src="{{ url_for('static', filename='uploads/eyecatch/' + post.eyecatch_img) }}"
                        class="w-full h-full object-cover">
                    {% else %}
                    <div id="eyecatch-placeholder" class="text-custom-text-muted flex flex-col items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-6 h-6 opacity-40">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6.75a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6.75v10.5a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                        </svg>
                        <span class="text-[10px] font-mono-dm uppercase tracking-wider">No Image</span>
                    </div>
                    {% endif %}
                </div>
                <div class="flex-1 flex flex-col gap-2">
                    <input type="file" id="eyecatch_img" name="eyecatch_img" accept="image/*"
                        class="text-[12px] text-custom-text-secondary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[11px] file:font-bold file:bg-custom-accent file:text-white hover:file:bg-opacity-90 transition-all cursor-pointer">
                    <p class="text-[11px] text-custom-text-muted">推奨サイズ: 1200x630px (1.91:1) | 形式: JPG, PNG, WEBP</p>
                </div>
            </div>
        </div>

        <!-- 本文 -->
        <div>
            <label for="content" class="label-admin">本文 <span class="text-red-500 ml-1">*</span></label>
            <textarea id="content" name="content" rows="15" placeholder="記事の内容を記述してください"
                class="input-admin h-auto py-3 resize-none font-sans text-sm leading-relaxed">{{ post.content if post else '' }}</textarea>
        </div>

        <!-- ACTIONS -->
        <div class="flex items-center justify-end gap-4 pt-4 border-t border-custom-border-light">
            <a href="{{ url_for('admin.post_list') }}"
                class="text-xs font-bold text-custom-text-muted hover:text-custom-text-secondary transition-colors uppercase tracking-widest font-mono-dm">Cancel</a>
            <button type="submit" class="btn-admin-primary px-8 py-2.5 text-sm">
                {{ '更新して保存' if post else 'この記事を投稿する' }}
            </button>
        </div>
    </form>
</div>
{% endblock %}